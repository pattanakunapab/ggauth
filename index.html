<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        //  CONFIG 1: ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Firebase Config ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDQBM66YRLXmtFx7lynCBrL2qty9HNd57o",
            authDomain: "loinby-cfdfe.firebaseapp.com",
            projectId: "loinby-cfdfe",
            storageBucket: "loinby-cfdfe.firebasestorage.app",
            messagingSenderId: "605737719385",
            appId: "1:605737719385:web:5a08679d76f7bb23cdc348"
        };

        const appme = initializeApp(firebaseConfig);
        const auth = getAuth(appme);
        const provider = new GoogleAuthProvider();

        window.loginWithGoogle = () => {
            signInWithPopup(auth, provider)
                .then((result) => { }).catch((error) => {
                    console.error("Login Error:", error);
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô: " + error.message);
                });
        };

        window.logoutFirebase = () => {
            signOut(auth).then(() => {
                location.reload();
            });
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const name = user.displayName;
                const email = user.email;
                
                renderLoading(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á ${name}...`);
                
                const result = await checkUserStatus(email);
                
                currentState.user = name; 
                currentState.userId = email;
                currentState.photoURL = user.photoURL;
                
                currentState.realName = name; 
                currentState.studentId = '';

                if (result) {
                    if (result.pretest && result.pretest.found) {
                        currentState.pretestData = {
                            isDone: true,
                            score: result.pretest.score,
                            answers: JSON.parse(result.pretest.answers || '{}')
                        };
                    }
                    if (result.posttest && result.posttest.found) {
                        currentState.posttestData = {
                            isDone: true,
                            score: result.posttest.score,
                            answers: JSON.parse(result.posttest.answers || '{}')
                        };
                    }
                }
                
                currentState.view = 'register';
                renderApp();
            }
        });
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        coffee: {
                            50: '#fdfbf7', 100: '#f7f3e8', 200: '#efe6d0', 300: '#e3d2ad',
                            400: '#d2b482', 500: '#c2965e', 600: '#a67846', 700: '#8c5f3a',
                            800: '#754e35', 900: '#614030',
                        }
                    },
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #fdfbf7;
            background-image: radial-gradient(#e3d2ad 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .coffee-shadow { box-shadow: 0 10px 25px -5px rgba(117, 78, 53, 0.15), 0 8px 10px -6px rgba(117, 78, 53, 0.1); }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #8c5f3a;
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-stone-800 antialiased">

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4"></div>

    <script>
        // ==========================================
        //  CONFIG 2: ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        // ==========================================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxvwe9U49mrbwwWXOdNBlTbxQ_RMhwl0Fg3uEeu60vU-04LoI7JLgW2iQDWt5MSgv33/exec"; 
        
        const ENABLE_POSTTEST = false;
        const ENABLE_SHOW_ANSWER = true;
        const ENABLE_RETAKE = true;

        const app = document.getElementById('app');
        
        let currentState = {
            view: 'login', user: '', userId: '', photoURL: '',
            quizType: 'pretest', 
            currentQuestionIndex: 0, 
            answers: {}, 
            score: 0, 
            
            realName: '',
            studentId: '',

            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï
            currentExamData: [],
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏ß‡πâ‡πÉ‡∏ô cache ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            pretestQuestions: null,
            posttestQuestions: null,

            pretestData: { isDone: false, score: 0, answers: {} },
            posttestData: { isDone: false, score: 0, answers: {} },
            
            isLoading: false
        };

        async function checkUserStatus(email) {
            if (!GAS_URL) return null;
            try {
                const response = await fetch(`${GAS_URL}?action=check&username=${encodeURIComponent(email)}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error checking user:", error);
                return null;
            }
        }

        async function fetchQuestions(type) {
            if (!GAS_URL) return [];
            try {
                const response = await fetch(`${GAS_URL}?action=getQuestions&quizType=${type}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("Error fetching questions:", error);
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï");
                return [];
            }
        }

        async function saveUserData(payload) {
            if (!GAS_URL) return;
            const formData = new FormData();
            formData.append('action', 'send');
            formData.append('username', payload.userId);
            formData.append('realName', payload.realName);
            formData.append('studentId', payload.studentId);
            formData.append('quizType', payload.quizType);
            formData.append('score', payload.score);
            formData.append('total', payload.total);
            formData.append('answers', JSON.stringify(payload.answers));

            try {
                const response = await fetch(GAS_URL, { method: 'POST', body: formData });
                return await response.json();
            } catch (error) {
                console.error("Error saving:", error);
                return { result: "error" };
            }
        }

        function renderLoading(message = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...") {
            app.innerHTML = `
                <div class="flex flex-col items-center justify-center fade-in">
                    <div class="loader mb-4 border-coffee-600"></div>
                    <p class="text-coffee-700 font-medium animate-pulse">${message}</p>
                </div>
            `;
        }

        function renderLogin() {
            app.innerHTML = `
                <div class="bg-white/80 backdrop-blur-md rounded-3xl coffee-shadow p-8 w-full max-w-md fade-in border-t-8 border-coffee-600">
                    <div class="text-center mb-8">
                        <div class="bg-coffee-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-coffee-200 shadow-inner">
                            <i data-lucide="coffee" class="w-10 h-10 text-coffee-700"></i>
                        </div>
                        <h1 class="text-2xl font-bold text-coffee-800 tracking-wide">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h1>
                        <p class="text-coffee-500 mt-2 font-light">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</p>
                    </div>
                    
                    <button onclick="loginWithGoogle()" 
                        class="w-full bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 font-bold py-3.5 rounded-xl transition-all shadow-md flex items-center justify-center gap-3">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                        Sign in with Google
                    </button>
                    
                    <p class="text-xs text-center text-gray-400 mt-6">
                        ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                    </p>
                </div>
            `;
            lucide.createIcons();
        }

        function renderRegister() {
            app.innerHTML = `
                <div class="bg-white/80 backdrop-blur-md rounded-3xl coffee-shadow p-8 w-full max-w-md fade-in border-t-8 border-coffee-600">
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold text-coffee-800">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                        <p class="text-coffee-500 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                    </div>
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-coffee-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)</label>
                            <input type="text" id="realNameInput" required value="${currentState.realName}" 
                                class="w-full px-4 py-2 border border-coffee-300 rounded-lg focus:ring-2 focus:ring-coffee-500 focus:outline-none" 
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÉ‡∏à‡∏î‡∏µ ‡∏°‡∏µ‡∏™‡∏∏‡∏Ç">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-coffee-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
                            <input type="text" id="studentIdInput" required value="${currentState.studentId}"
                                class="w-full px-4 py-2 border border-coffee-300 rounded-lg focus:ring-2 focus:ring-coffee-500 focus:outline-none" 
                                placeholder="‡πÄ‡∏ä‡πà‡∏ô 641234567">
                        </div>
                        <button type="submit" 
                            class="w-full bg-coffee-600 hover:bg-coffee-700 text-white font-bold py-3 rounded-xl transition-all shadow-md mt-4">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                        </button>
                    </form>
                </div>
            `;
            
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                currentState.realName = document.getElementById('realNameInput').value.trim();
                currentState.studentId = document.getElementById('studentIdInput').value.trim();
                
                if(!currentState.realName || !currentState.studentId) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }
                
                currentState.view = 'menu';
                renderApp();
            });
        }

        function renderMenu() {
            const profileImg = currentState.photoURL 
                ? `<img src="${currentState.photoURL}" class="w-20 h-20 rounded-full mx-auto mb-4 border-2 border-white/30 shadow-lg object-cover">`
                : `<div class="bg-white/20 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 backdrop-blur-sm border border-white/30 shadow-lg"><span class="text-3xl">üëµ</span></div>`;

            let pretestHtml = '';
            const pre = currentState.pretestData;
            
            if (pre.isDone) {
                let btns = '';
                if (ENABLE_SHOW_ANSWER) {
                    btns += `<button onclick="reviewQuiz('pretest')" class="text-xs bg-white border border-coffee-300 text-coffee-700 px-3 py-2 rounded-lg hover:bg-coffee-50 flex items-center gap-1"><i data-lucide="eye" class="w-3 h-3"></i> ‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢</button>`;
                }
                if (ENABLE_RETAKE) {
                    btns += `<button onclick="startQuiz('pretest')" class="text-xs bg-coffee-100 text-coffee-800 px-3 py-2 rounded-lg hover:bg-coffee-200 flex items-center gap-1"><i data-lucide="rotate-ccw" class="w-3 h-3"></i> ‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà</button>`;
                }

                pretestHtml = `
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-4 text-left">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-green-800">Pre-test (‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h4>
                                <span class="text-xs bg-green-200 text-green-800 px-2 py-0.5 rounded-full">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-green-700">${pre.score}</span>
                                <span class="text-xs text-green-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            ${btns}
                        </div>
                    </div>
                `;
            } else {
                pretestHtml = `
                    <div class="bg-white border border-coffee-200 rounded-xl p-4 mb-4 text-left hover:shadow-md transition">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-bold text-coffee-800">Pre-test (‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h4>
                            <span class="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏≥</span>
                        </div>
                        <button onclick="startQuiz('pretest')" class="w-full bg-coffee-600 hover:bg-coffee-700 text-white font-bold py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm">
                            <i data-lucide="play-circle" class="w-4 h-4"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                        </button>
                    </div>
                `;
            }

            let posttestHtml = '';
            const post = currentState.posttestData;

            if (!ENABLE_POSTTEST) {
                posttestHtml = `
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 text-left opacity-75">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-gray-500">Post-test (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h4>
                            <i data-lucide="lock" class="w-4 h-4 text-gray-400"></i>
                        </div>
                        <div class="text-xs text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ</div>
                    </div>
                `;
            } else {
                if (post.isDone) {
                    let btns = '';
                    if (ENABLE_SHOW_ANSWER) {
                        btns += `<button onclick="reviewQuiz('posttest')" class="text-xs bg-white border border-blue-300 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-50 flex items-center gap-1"><i data-lucide="eye" class="w-3 h-3"></i> ‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢</button>`;
                    }

                    posttestHtml = `
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 text-left">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-blue-800">Post-test (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h4>
                                    <span class="text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded-full">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-2xl font-bold text-blue-700">${post.score}</span>
                                    <span class="text-xs text-blue-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                ${btns}
                            </div>
                        </div>
                    `;
                } else {
                    posttestHtml = `
                        <div class="bg-white border border-blue-200 rounded-xl p-4 text-left hover:shadow-md transition">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-bold text-blue-800">Post-test (‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h4>
                                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
                            </div>
                            <button onclick="startQuiz('posttest')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="play-circle" class="w-4 h-4"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                            </button>
                        </div>
                    `;
                }
            }

            app.innerHTML = `
                <div class="w-full max-w-md fade-in flex flex-col justify-center">
                    <div class="bg-white/90 backdrop-blur rounded-3xl coffee-shadow overflow-hidden mb-6 border border-coffee-100">
                        <div class="bg-gradient-to-br from-coffee-600 to-coffee-800 p-8 text-white text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/coffee.png')]"></div>
                            <div class="relative z-10">
                                ${profileImg}
                                <h2 class="text-2xl font-bold tracking-wide">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
                                <p class="text-coffee-100 mt-1 font-light mb-1">${currentState.realName || currentState.user}</p>
                                <p class="text-coffee-200 text-xs font-light">ID: ${currentState.studentId || '-'}</p>
                            </div>
                        </div>
                        <div class="p-6">
                             ${pretestHtml}
                             ${posttestHtml}
                        </div>
                    </div>
                     <button onclick="logoutFirebase()" class="text-coffee-400 hover:text-coffee-600 text-sm font-medium transition flex items-center justify-center gap-1 mx-auto">
                        <i data-lucide="log-out" class="w-4 h-4"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                     </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderQuiz() {
            // ‡πÉ‡∏ä‡πâ currentExamData ‡πÅ‡∏ó‡∏ô examData
            const questions = currentState.currentExamData;
            
            if (!questions || questions.length === 0) {
                app.innerHTML = `<div class="text-center p-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</div>`;
                return;
            }

            const question = questions[currentState.currentQuestionIndex];
            const progress = ((currentState.currentQuestionIndex + 1) / questions.length) * 100;
            const isLastQuestion = currentState.currentQuestionIndex === questions.length - 1;
            const currentAnswer = currentState.answers[currentState.currentQuestionIndex];
            const hasAnsweredCurrent = currentAnswer !== undefined; 
            
            const isReviewMode = (currentState.quizType === 'pretest' && currentState.pretestData.isDone) || 
                                 (currentState.quizType === 'posttest' && currentState.posttestData.isDone);

            const typeLabel = currentState.quizType === 'pretest' ? 'Pre-test' : 'Post-test';
            const title = isReviewMode ? `‡πÄ‡∏â‡∏•‡∏¢ ${typeLabel}` : `‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ${typeLabel}`;

            let optionsHtml = '';
            question.options.forEach((opt, idx) => {
                const isSelected = currentAnswer === idx;
                const isCorrect = idx === question.correctAnswer;
                let borderClass = 'border-white';
                let bgClass = 'bg-coffee-50/50';
                let icon = '';

                if (isReviewMode) {
                    if (isSelected) {
                        if (isCorrect) {
                            borderClass = 'border-green-500'; bgClass = 'bg-green-100';
                            icon = '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>';
                        } else {
                            borderClass = 'border-red-500'; bgClass = 'bg-red-100';
                            icon = '<i data-lucide="x-circle" class="w-5 h-5 text-red-600"></i>';
                        }
                    } else if (isCorrect) {
                        borderClass = 'border-green-300'; bgClass = 'bg-green-50/50';
                        icon = '<i data-lucide="check" class="w-4 h-4 text-green-400"></i>';
                    }
                } else {
                    if (isSelected) {
                        borderClass = 'border-coffee-500'; bgClass = 'bg-coffee-100 text-coffee-900 shadow-inner';
                    } else {
                        borderClass = 'border-white hover:border-coffee-300 hover:bg-white hover:shadow-sm';
                    }
                }

                optionsHtml += `
                    <button onclick="${isReviewMode ? '' : `selectAnswer(${idx})`}"
                        class="w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center mb-3 group ${borderClass} ${bgClass} ${isReviewMode ? 'cursor-default' : ''}">
                        <div class="w-7 h-7 rounded-full border-2 mr-4 flex items-center justify-center flex-shrink-0 transition-colors
                            ${isSelected ? 'border-coffee-500 bg-coffee-500 text-white' : 'border-coffee-300 text-transparent group-hover:border-coffee-400'}">
                            ${isSelected ? '<i data-lucide="check" class="w-4 h-4"></i>' : ''}
                        </div>
                        <span class="text-coffee-800 font-medium leading-relaxed flex-grow">${opt}</span>
                        ${icon}
                    </button>
                `;
            });

            app.innerHTML = `
                <div class="w-full max-w-3xl flex flex-col min-h-screen sm:min-h-0 sm:h-auto">
                    <div class="flex justify-between items-center mb-6 bg-white/90 backdrop-blur p-5 rounded-2xl coffee-shadow border border-coffee-100">
                        <h2 class="text-xl font-bold text-coffee-800 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-5 h-5 text-coffee-500"></i>
                            ${title}
                        </h2>
                        <span class="bg-coffee-100 text-coffee-800 px-4 py-1.5 rounded-full text-sm font-bold shadow-sm border border-coffee-200">
                            ‡∏Ç‡πâ‡∏≠ ${currentState.currentQuestionIndex + 1} / ${questions.length}
                        </span>
                    </div>
                    <div class="w-full bg-coffee-200 rounded-full h-3 mb-8 shadow-inner overflow-hidden">
                        <div class="bg-gradient-to-r from-coffee-500 to-coffee-600 h-3 rounded-full transition-all duration-500 ease-out shadow-sm" style="width: ${progress}%"></div>
                    </div>
                    <div class="bg-white rounded-3xl coffee-shadow p-8 mb-8 flex-grow border border-white/50 relative">
                         <div class="absolute top-0 right-0 p-4 opacity-5"><i data-lucide="coffee" class="w-24 h-24 text-coffee-900"></i></div>
                        <h3 class="text-lg font-bold text-coffee-900 mb-8 leading-relaxed relative z-10">
                            ${question.id}. ${question.question}
                        </h3>
                        <div class="space-y-3 relative z-10">${optionsHtml}</div>
                    </div>
                    <div class="flex justify-between items-center mt-auto pt-4 pb-8 sm:pb-0">
                         ${isReviewMode ? `
                             <button onclick="backToMenu()" 
                                class="px-6 py-3 rounded-xl font-bold text-coffee-600 bg-white border border-coffee-200 hover:bg-coffee-50 transition shadow-sm">
                                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏¢
                            </button>
                         ` : `
                             <button onclick="prevQuestion()" 
                                class="px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 
                                ${currentState.currentQuestionIndex === 0 ? 'text-coffee-300 cursor-not-allowed' : 'text-coffee-700 bg-white hover:bg-coffee-50 shadow-md hover:shadow-lg border border-coffee-100'}"
                                ${currentState.currentQuestionIndex === 0 ? 'disabled' : ''}>
                                <i data-lucide="chevron-left" class="w-5 h-5"></i> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö
                            </button>
                         `}
                        <div class="flex gap-2">
                             ${currentState.currentQuestionIndex > 0 && isReviewMode ? `
                                <button onclick="prevQuestion()" class="px-4 py-3 bg-white border border-coffee-200 rounded-xl hover:bg-coffee-50 text-coffee-700"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                             ` : ''}
                            ${isLastQuestion ? (isReviewMode ? '' : `
                                <button onclick="submitQuiz()" id="submitBtn" ${!hasAnsweredCurrent ? 'disabled' : ''}
                                    class="px-8 py-3 rounded-xl font-bold text-white transition-all shadow-lg flex items-center gap-2 
                                    ${!hasAnsweredCurrent ? 'bg-coffee-300 cursor-not-allowed' : 'bg-coffee-600 hover:bg-coffee-700 transform hover:-translate-y-1'}">
                                    ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö <i data-lucide="send" class="w-4 h-4"></i>
                                </button>
                            `) : `
                                <button onclick="nextQuestion()" ${!hasAnsweredCurrent && !isReviewMode ? 'disabled' : ''}
                                    class="px-8 py-3 rounded-xl font-bold text-white transition-all shadow-lg flex items-center gap-2 
                                    ${(!hasAnsweredCurrent && !isReviewMode) ? 'bg-coffee-300 cursor-not-allowed' : 'bg-coffee-600 hover:bg-coffee-700 transform hover:-translate-y-1'}">
                                    ${isReviewMode ? '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ' : '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'} <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderResult() {
            let score = currentState.score;
            let typeLabel = currentState.quizType === 'pretest' ? 'Pre-test' : 'Post-test';
            let total = currentState.currentExamData.length;

            app.innerHTML = `
                <div class="w-full max-w-2xl fade-in text-center">
                    <div class="bg-white rounded-3xl coffee-shadow p-10 mb-8 border-t-8 border-coffee-600">
                        <div class="w-24 h-24 bg-coffee-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border-4 border-white">
                            <i data-lucide="award" class="w-12 h-12 text-coffee-600"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-coffee-900 mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏• ${typeLabel} ‡πÅ‡∏•‡πâ‡∏ß!</h2>
                        <p class="text-coffee-500 mb-8 font-light">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</p>
                        <div class="text-7xl font-bold text-coffee-600 mb-2 tracking-tight">${score}</div>
                        <div class="text-coffee-400 font-bold text-sm uppercase tracking-widest mb-2">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
                        <div class="text-coffee-300 text-sm">‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${total} ‡∏Ç‡πâ‡∏≠</div>
                    </div>
                    <div class="mt-10">
                        <button onclick="backToMenu()" class="bg-white text-coffee-700 border-2 border-coffee-200 hover:border-coffee-400 hover:bg-coffee-50 px-10 py-3.5 rounded-xl font-bold shadow-lg transition-all transform hover:-translate-y-1">
                            ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                        </button>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderApp() {
            if (currentState.view === 'login') renderLogin();
            else if (currentState.view === 'register') renderRegister();
            else if (currentState.view === 'menu') renderMenu();
            else if (currentState.view === 'quiz') renderQuiz();
            else if (currentState.view === 'result') renderResult();
        }

        // --- GLOBAL ACTIONS ---
        window.startQuiz = async (type) => { 
            currentState.quizType = type;
            
            // Check cache or fetch new
            let questions = [];
            if(type === 'pretest' && currentState.pretestQuestions) {
                questions = currentState.pretestQuestions;
            } else if (type === 'posttest' && currentState.posttestQuestions) {
                questions = currentState.posttestQuestions;
            } else {
                renderLoading(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ${type === 'pretest' ? 'Pre-test' : 'Post-test'}...`);
                questions = await fetchQuestions(type);
                // Save to cache
                if(type === 'pretest') currentState.pretestQuestions = questions;
                else currentState.posttestQuestions = questions;
            }

            if(questions.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏µ‡∏ï‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà');
                renderMenu();
                return;
            }

            currentState.currentExamData = questions;
            currentState.currentQuestionIndex = 0; 
            currentState.answers = {}; 
            currentState.score = 0; 
            
            if(type === 'pretest') currentState.pretestData.isDone = false;
            if(type === 'posttest') currentState.posttestData.isDone = false;
            
            currentState.view = 'quiz'; 
            renderApp(); 
        };

        window.reviewQuiz = async (type) => { 
            currentState.quizType = type;
            
            // Need questions to review
            if(type === 'pretest' && !currentState.pretestQuestions) {
                 renderLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                 currentState.pretestQuestions = await fetchQuestions(type);
            }
            if(type === 'posttest' && !currentState.posttestQuestions) {
                 renderLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                 currentState.posttestQuestions = await fetchQuestions(type);
            }

            currentState.currentExamData = type === 'pretest' ? currentState.pretestQuestions : currentState.posttestQuestions;
            
            if(!currentState.currentExamData || currentState.currentExamData.length === 0) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö');
                renderMenu();
                return;
            }

            currentState.currentQuestionIndex = 0;
            if(type === 'pretest') currentState.answers = currentState.pretestData.answers;
            if(type === 'posttest') currentState.answers = currentState.posttestData.answers;
            
            if(type === 'pretest') currentState.pretestData.isDone = true;
            if(type === 'posttest') currentState.posttestData.isDone = true;
            
            currentState.view = 'quiz'; 
            renderApp(); 
        };

        window.selectAnswer = (i) => { 
            currentState.answers[currentState.currentQuestionIndex] = i; 
            renderQuiz(); 
        };
        
        window.nextQuestion = () => { 
            if(currentState.currentQuestionIndex < currentState.currentExamData.length - 1) { 
                currentState.currentQuestionIndex++; 
                renderQuiz(); 
            } 
        };
        
        window.prevQuestion = () => { 
            if(currentState.currentQuestionIndex > 0) { 
                currentState.currentQuestionIndex--; 
                renderQuiz(); 
            } 
        };
        
        window.backToMenu = () => { 
            currentState.view = 'menu'; 
            renderApp(); 
        };
        
        window.submitQuiz = async () => {
            if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö?')) return;
            
            const questions = currentState.currentExamData;
            let score = 0;
            questions.forEach((q, idx) => { if(currentState.answers[idx] === q.correctAnswer) score++; });
            
            currentState.score = score;
            
            if (currentState.quizType === 'pretest') {
                currentState.pretestData = { isDone: true, score: score, answers: {...currentState.answers} };
            } else {
                currentState.posttestData = { isDone: true, score: score, answers: {...currentState.answers} };
            }

            renderLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö...');
            
            await saveUserData({ 
                user: currentState.user, 
                userId: currentState.userId,
                realName: currentState.realName,
                studentId: currentState.studentId,
                quizType: currentState.quizType,
                score: score, 
                total: questions.length, 
                answers: currentState.answers 
            });
            
            currentState.view = 'result';
            renderApp();
        };

        renderLogin();

    </script>
</body>
</html>
